<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="/static/css/style.css">
  <title>AI ê¸°ë°˜ ë°œìŒ í‰ê°€</title>
</head>
<body>
  <h1>ğŸ™ï¸ L2 ë°œí™” ì–µì–‘/ë°œìŒ í‰ê°€ê¸°</h1>

  <!-- ê¸°ì¡´ íŒŒì¼ ì—…ë¡œë“œ í¼ -->
  <form id="analyzeForm" action="/analyze/" method="post" enctype="multipart/form-data">
    <label for="file">ğŸ—‚ï¸ ìŒì„± íŒŒì¼ (.wav, .m4a, .webm)</label><br>
    <input type="file" id="fileInput" name="file" accept=".wav,.m4a,.webm" required><br><br>

    <label for="reference">ğŸ“„ ê¸°ì¤€ ë¬¸ì¥ (L1 Reference)</label><br>
    <select name="reference" id="reference" required>
      <option value="1">He was pressing beyond the limits of his vocabulary.</option>
      <option value="2">But he reconciled himself to it by an act of faith.</option>
      <option value="3">Each insult added to the value of the claim.</option>
      <option value="4">There is more behind this than a mere university ideal.</option>
      <option value="5">You're a devil for fighting, and will surely win.</option>
    </select>

    <input type="hidden" name="mel_path" id="mel_path_input"><br><br>

    <button type="submit">ğŸš€ ë¶„ì„ ì‹œì‘</button>
  </form>

  <hr>

  <!-- ì›¹ ë…¹ìŒ ê¸°ëŠ¥ ì¶”ê°€ -->
  <h2>ğŸ¤ ì›¹ì—ì„œ ì§ì ‘ ë…¹ìŒí•´ì„œ ë¶„ì„í•˜ê¸°</h2>
  <button id="recordBtn">ğŸ”´ ë…¹ìŒ ì‹œì‘</button>
  <button id="stopBtn" disabled>â¹ï¸ ë…¹ìŒ ì •ì§€</button>
  <br><br>
  <audio id="audioPlayer" controls></audio>

  <script>
    const melMap = {
      "1": "spectrogram/L1/1_L1_mels.npy",
      "2": "spectrogram/L1/2_L1_mels.npy",
      "3": "spectrogram/L1/3_L1_mels.npy",
      "4": "spectrogram/L1/4_L1_mels.npy",
      "5": "spectrogram/L1/5_L1_mels.npy"
    };

    const select = document.getElementById("reference");
    const melInput = document.getElementById("mel_path_input");

    select.addEventListener("change", () => {
      melInput.value = melMap[select.value];
    });

    window.addEventListener("DOMContentLoaded", () => {
      melInput.value = melMap[select.value];
    });

    // ë…¹ìŒ ê¸°ëŠ¥
    let mediaRecorder;
    let audioChunks = [];

    const recordBtn = document.getElementById('recordBtn');
    const stopBtn = document.getElementById('stopBtn');
    const audioPlayer = document.getElementById('audioPlayer');
    const fileInput = document.getElementById('fileInput');

    recordBtn.addEventListener('click', async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = event => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const audioUrl = URL.createObjectURL(audioBlob);
        audioPlayer.src = audioUrl;

        const file = new File([audioBlob], 'recording.webm', { type: 'audio/webm' });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;

        alert("âœ… ë…¹ìŒì´ ì™„ë£Œë˜ì–´ ìë™ìœ¼ë¡œ ì—…ë¡œë“œ ëŒ€ìƒì´ ë˜ì—ˆìŠµë‹ˆë‹¤!");
      };

      mediaRecorder.start();
      recordBtn.disabled = true;
      stopBtn.disabled = false;
    });

    stopBtn.addEventListener('click', () => {
      mediaRecorder.stop();
      recordBtn.disabled = false;
      stopBtn.disabled = true;
    });
  </script>
</body>
</html>
